{% extends "base.html" %}
{% load static %}

{% block content %}

<h2>Secure Payment</h2>

<div class="payment-container">

    <!-- ORDER SUMMARY -->
    <div class="order-summary">
        <h3>Order Summary</h3>
        <p><strong>Service:</strong> {{ order.service.name }}</p>
        <p><strong>Origin:</strong> {{ order.origin_country }}</p>
        <p><strong>Destination:</strong> {{ order.destination_country }}</p>
        <p><strong>Weight:</strong> {{ order.weight_kg }} kg</p>
        <p><strong>Volume:</strong> {{ order.volume_cbm }} CBM</p>

        <hr>

        <p><strong>Tax:</strong> ${{ order.tax_amount }}</p>
        <p class="total">
            <strong>Total:</strong> ${{ order.total_amount }}
        </p>
    </div>

    <!-- PAYMENT FORM -->
    <div class="payment-box">
        <h3>Card Payment</h3>

        {% if settings.DEBUG %}
            <div class="test-mode-banner">
                ⚠ Test Mode — Use card <strong>4242 4242 4242 4242</strong>
            </div>
        {% endif %}

        <form id="payment-form">
            <div id="card-element"></div>
            <div id="card-errors" role="alert"></div>

            <button id="pay-button">
                Pay ${{ order.total_amount }}
            </button>
        </form>
    </div>

</div>

<script src="https://js.stripe.com/v3/"></script>

<script>
    const stripe = Stripe("{{ stripe_public_key }}");
    const elements = stripe.elements();

    const card = elements.create("card", {
        style: {
            base: {
                fontSize: "16px",
                color: "#32325d",
                "::placeholder": {
                    color: "#a0aec0"
                }
            }
        }
    });

    card.mount("#card-element");

    const form = document.getElementById("payment-form");
    const payButton = document.getElementById("pay-button");

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        payButton.disabled = true;
        payButton.innerText = "Processing...";

        const { error, paymentIntent } = await stripe.confirmCardPayment(
            "{{ client_secret }}",
            {
                payment_method: {
                    card: card
                }
            }
        );

        if (error) {
            document.getElementById("card-errors").textContent = error.message;
            payButton.disabled = false;
            payButton.innerText = "Pay ${{ order.total_amount }}";
        } else if (paymentIntent.status === "succeeded") {
            window.location.href = "{% url 'orders:stripe_success' order.id %}";
        }
    });
</script>

{% endblock %}
